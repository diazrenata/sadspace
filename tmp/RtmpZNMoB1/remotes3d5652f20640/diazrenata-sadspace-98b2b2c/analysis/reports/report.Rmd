---
title: "SAD space report"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(drake)
library(sadspace)
library(dplyr)
library(ggplot2)
library(ggpmisc)
```

```{r load stuff}

sv <- define_statevars() %>%
  assign_ptable() %>%
  dplyr::filter(p_table != "none")

#di_df <- read.csv(here::here("analysis", "di_dfs.csv"), stringsAsFactors = F)
fs_size_dat <- read.csv(here::here("analysis", "fs_size_dat.csv"), stringsAsFactors = F)
di_summary_df <- read.csv(here::here("analysis", "di_summary_df.csv"), stringsAsFactors = F)

```

Here is the range of S and N space covered:

```{r plot sn space, fig.dim = c(3.5, 3.5)}

ggplot(sv, aes(s0, n0, color = n0/s0)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "plasma") +
  theme(legend.position = "top")

ggplot(sv, aes(log(s0), log(n0), color = log(n0/s0))) +
  geom_point() +
  theme_bw()+
  scale_color_viridis_c(option = "plasma")+
  theme(legend.position = "top")
```

Things are generally easier to see on the log axis, so let's stick with that.

## Size and unique elements from FS

Here is how the size of the feasible set varies with S, N, and N/S:

```{r plot size of fs 1}
# 
# fs_size_dat <- di_df %>%
#   select(s0, n0, nparts, nunique) %>%
#   distinct() %>%
#   mutate(log_nparts = log(as.numeric(nparts)),
#          log_nunique = log(nunique))

ggplot(fs_size_dat, aes(log(s0), log(n0), color =log_nparts)) +
  geom_point() + 
  theme_bw()+
  scale_color_viridis_c(option = "plasma", begin = .1, end = .8)+
  theme(legend.position = "top")

```


This is *on a log scale*, so up in that right corner is *1.942426e+130*. 

```{r plot size of fs 2, fig.dim = c(4,3)}
ggplot(fs_size_dat, aes(log(s0), log_nparts, color = (log(n0)))) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

ggplot(fs_size_dat, aes(log(s0), log_nparts, group = as.factor(log(n0)), color = log(n0))) +
  geom_line() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

ggplot(fs_size_dat, aes(log(n0), log_nparts, color = (log(s0)))) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

ggplot(fs_size_dat, aes(log(n0), log_nparts, group = as.factor(log(s0)), color = log(s0))) +
  geom_line() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")
ggplot(fs_size_dat, aes(log(n0/s0), log_nparts, color = (log(n0)))) +
  geom_point() +
  theme_bw()+
  scale_color_viridis_c() +
  theme(legend.position = "top")
ggplot(fs_size_dat, aes(log(n0/s0), log_nparts, group = as.factor(log(n0)), color = log(n0))) +
  geom_line() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")
ggplot(fs_size_dat, aes(log(n0/s0), log_nparts, color = (log(s0)))) +
  geom_point() +
  theme_bw()+
  scale_color_viridis_c() +
  theme(legend.position = "top")
ggplot(fs_size_dat, aes(log(n0/s0), log_nparts, group = as.factor(log(s0)), color = log(s0))) +
  geom_line() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

```

Note that the number of elements *would* continue to increase, except we hit the edge of the sampling space.

Here is the number of unique FS found, and the number of unique FS over the number that exist. Note that the number of draws was 10,000, so the maximum possible log(nunique) would be 9.2. FS that found 10,000 unique draws are covered with black dots in this plot:

```{r nunique 1}

ggplot(fs_size_dat, aes(log(s0), log(n0), color = log_nunique)) +
  geom_point() +
  geom_point(data = filter(fs_size_dat, log_nunique >= 9.2), color = "black") +
  scale_color_viridis_c(option = "plasma", end = .9) +
  theme_bw() +
  theme(legend.position = "top")
```


Here is the number of unique samples found relative to the number possible. FS that found all the elements possible are covered with green dots:

```{r nunique 2, fig.dim = c(4,3)}

ggplot(fs_size_dat, aes(log(s0), log(n0), color = log_nunique - log_nparts)) +
  geom_point() +
  geom_point(data = filter(fs_size_dat, log_nunique == log_nparts), color = "green")+ 
  scale_color_viridis_c(option = "plasma", end = .8, begin = .1, direction = -1) +
  theme_bw() +
  theme(legend.position = "top")

ggplot(fs_size_dat, aes(x = log(n0/s0), y = log_nunique - log_nparts, group = log(s0), color = log(s0))) +
  geom_line() +
  scale_color_viridis_c() +
  theme_bw() +
  theme(legend.position = "top")

```


## Skewness behavior

Both skewness and the variability in skewness decrease with N/S, and increase with S. For a given S, a higher N/S (so higher N) will have lower skew and lower variability. 

I don't think it matters very much whether you look at mean or median/range or sd.

```{r skewness, fig.dim = c(4,3)}

ggplot(data = di_summary_df, aes(log(s0), log(n0), color = mean_skew)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "plasma") +
  theme(legend.position = "top")

ggplot(data = di_summary_df, aes(x = log(n0/s0), group = log(s0), color = log(s0), y = mean_skew)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

ggplot(data = di_summary_df, aes(log(s0), log(n0), color = median_skew)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "plasma") +
  theme(legend.position = "top")

ggplot(data = di_summary_df, aes(x = log(n0/s0), group = log(s0), color = log(s0), y = median_skew)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

ggplot(data = filter(di_summary_df, !is.na(sd_skew)), aes(log(s0), log(n0), color = sd_skew)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "plasma") +
  theme(legend.position = "top")

ggplot(data = filter(di_summary_df, !is.na(sd_skew)), aes(x = log(n0/s0), group = log(s0), color = log(s0), y = sd_skew)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

ggplot(data = filter(di_summary_df, !is.na(range_skew)), aes(log(s0), log(n0), color = range_skew)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "plasma") +
  theme(legend.position = "top")

ggplot(data = filter(di_summary_df, !is.na(range_skew)), aes(x = log(n0/s0), group = log(s0), color = log(s0), y = range_skew)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

```


This behavior is a little hard to understand - why should high N communities have *lower* skew? Let's look more closely at a few communities.

These are the communities we'll pull out:


```{r plot focal communities}


focal_communities <- data.frame(
  s0 = c(3, 3, 3, 34, 34, 34, 666),
  n0 = c(8, 1097, 36316, 55, 1097, 36316, 1097)
)


focal_communities <- focal_communities %>%
  mutate(target_name = paste0("fs_", s0, "_", n0))

## this is scrap code to pull 3000 unique sims per focal community from cache on hpg. Drawing more gives v large .csvs for large communities.
# for(i in 1:nrow(focal_communities)) {
# thisobj = get_object(focal_communities$target_name[i])
# thisobj <- thisobj %>% filter(sim %in% unique(sim)[1:3000])
# write.csv(thisobj, here::here("analysis", "reports", paste0(focal_communities$target_name[i], ".csv")), row.names = F)
# }
focal_communities <- left_join(focal_communities, fs_size_dat, by = c("s0", "n0"))

ggplot(fs_size_dat, aes(log(s0), log(n0), color =log_nparts)) +
  geom_point(alpha = .2) + 
  geom_point(data = focal_communities, alpha = 1, shape = 8, size = 2) +
  theme_bw()+
  scale_color_viridis_c(option = "plasma", begin = .1, end = .8)+
  theme(legend.position = "top")

focal_communities <- focal_communities %>%
  mutate(file_name = here::here("analysis", "reports", paste0(target_name, ".csv")))

focal_fs <- list()
for(i in 1:nrow(focal_communities)) {
  focal_fs[[i]] <- read.csv(focal_communities$file_name[i], stringsAsFactors = F)
  
  focal_fs[[i]] <-  focal_fs[[i]] %>%
    group_by(sim, nparts, s0, n0) %>%
    mutate(skew = e1071::skewness(abund),
           simpson = vegan::diversity(abund, index = "simpson")) %>%
    ungroup() %>%
    mutate(s0_f = as.factor(s0),
           n0_f = as.factor(n0))
}



```


```{r focal heatmaps, fig.dim = c(4,4)}
make_heatmap <- function(focal_fs_df, color_var) {
  
  if(length(unique(focal_fs_df$sim)) <= 100) {
    max_alpha <- .5
  } else {
    max_alpha <- .1
  }
  
  if(color_var == "skew") {
    
    spplot <- ggplot(di_summary_df, aes(log(s0), log(n0), color =mean_skew)) +
      geom_point(alpha = .2) + 
      geom_point(data = filter(di_summary_df, s0 == focal_fs_df$s0[1], n0 == focal_fs_df$n0[[1]]), alpha = 1, shape = 8, size = 5) +
      theme_bw()+
      scale_color_viridis_c(option = "plasma", begin = .1, end = .8)+
      theme(legend.position = "none",axis.title.x=element_blank(),
            axis.text.x=element_blank(),
            axis.ticks.x=element_blank(),
            axis.title.y=element_blank(),
            axis.text.y=element_blank(),
            axis.ticks.y=element_blank())
    
    
  } else {
    spplot <- ggplot(di_summary_df, aes(log(s0), log(n0), color =mean_simpson))+
      geom_point(alpha = .2) + 
      geom_point(data = filter(di_summary_df, s0 == focal_fs_df$s0[1], n0 == focal_fs_df$n0[[1]]), alpha = 1, shape = 8, size = 5) +
      theme_bw()+
      scale_color_viridis_c(option = "plasma", begin = .1, end = .8)+
      theme(legend.position = "none",axis.title.x=element_blank(),
            axis.text.x=element_blank(),
            axis.ticks.x=element_blank(),
            axis.title.y=element_blank(),
            axis.text.y=element_blank(),
            axis.ticks.y=element_blank())
  }
  
  
  smallp <- tibble(x = 1, y = max(focal_fs_df$abund), plot= list(spplot))
  
  if(color_var == "skew") {
    return(
      ggplot(data = focal_fs_df, aes(x = rank, y = abund, color = skew, group = sim)) +
        geom_line(alpha = max_alpha) +
        scale_color_viridis_c() +
        theme_bw() +
        geom_plot(data = smallp, aes(x, y, label = plot), vp.width = .4, vp.height = .4) +
        theme(legend.position = "top")
      
    )
    
  } else {
    ggplot(data = focal_fs_df, aes(x = rank, y = abund, color = simpson, group = sim)) +
      geom_line(alpha = max_alpha) +
      scale_color_viridis_c() +
      theme_bw() +
      geom_plot(data = smallp, aes(x, y, label = plot), vp.width = .4, vp.height = .4)+
      theme(legend.position = "top")
  }
}
skew_hm <- lapply(focal_fs, FUN = make_heatmap, color_var = "skew")

for(i in 1:length(skew_hm)) {
  print(skew_hm[[i]])
}

```

It looks like 

- Skewness depends largely on S. Higher S creates the possibility of having higher skew values. N doesn't change too much. I suspect that increasing N increases the abundance of not-the-most-skewed vectors, which is why the means and variability are lower. 
- Within a FS, skewness broadly tracks intuition.

So, I wouldn't interpret too heavily from skewness values from distributions with vastly different S and N. 

## Simpson behavior

Simpson is generally higher as S increases; it doesn't seem to change too much with N on top of the S change - if anything, it decreases with N for a given S. Variability is high for low S. 

```{r simpson, fig.dim = c(4,3)}

ggplot(data = di_summary_df, aes(log(s0), log(n0), color = mean_simpson)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "plasma") +
  theme(legend.position = "top")

ggplot(data = di_summary_df, aes(x = log(n0/s0), group = log(s0), color = log(s0), y = mean_simpson)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

ggplot(data = di_summary_df, aes(log(s0), log(n0), color = median_simpson)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "plasma") +
  theme(legend.position = "top")

ggplot(data = di_summary_df, aes(x = log(n0/s0), group = log(s0), color = log(s0), y = median_simpson)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")
ggplot(data = filter(di_summary_df, !is.na(sd_simpson)), aes(log(s0), log(n0), color = sd_simpson)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "plasma") +
  theme(legend.position = "top")

ggplot(data = filter(di_summary_df, !is.na(sd_simpson)), aes(x = log(n0/s0), group = log(s0), color = log(s0), y = sd_simpson)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

ggplot(data = filter(di_summary_df, !is.na(range_simpson)), aes(log(s0), log(n0), color = range_simpson)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(option = "plasma") +
  theme(legend.position = "top")

ggplot(data = filter(di_summary_df, !is.na(range_simpson)), aes(x = log(n0/s0), group = log(s0), color = log(s0), y = range_simpson)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_c() +
  theme(legend.position = "top")

```

Let's look at those same heatmaps for Simpson's:

```{r simpson hm, fig.dim = c(4,4)}

simpson_hm <- lapply(focal_fs, FUN = make_heatmap, color_var = "simpson")
for(i in 1:length(simpson_hm)) {
  print(simpson_hm[[i]])
}
```

Simpson gets EXTREMELY HIGH for large S and to a lesser extent large N communities. 

Simpson for different S and N, and especially different S, are NOT COMPARABLE. 


## Distributions of skewness and simpson w nsamples

```{r dists}

make_distplot <- function(focal_fs_df, varname) {
  
  
  focal_fs_df <- focal_fs_df %>%
    select(simpson, skew, sim, s0, n0) %>%
    distinct() 
  
  nsim <- length(unique(focal_fs_df$sim))
  
  focal_fs_df$section <- "large"
  focal_fs_df$section[ which(focal_fs_df$sim %in% unique(focal_fs_df$sim)[1: floor(nsim / 5)])] <- "small"
  
  if(varname == "skew") {

    return(
      ggplot(data = focal_fs_df, aes(x = skew)) +
        geom_histogram() +
        theme_bw() +
        facet_wrap(vars(section), scales = "free_y")
    )
    
  } else {

    return(ggplot(data = focal_fs_df, aes(x = simpson)) +
        geom_histogram() +
        theme_bw() +
        facet_wrap(vars(section), scales = "free_y") +
      xlim(0, 1) +
      theme_bw())
      }
}
skew_dp <- lapply(focal_fs, FUN = make_distplot, varname = "skew")

for(i in 1:length(skew_dp)) {
  print(skew_dp[[i]])
}


simpson_dp <- lapply(focal_fs, FUN = make_distplot, varname = "simpson")

for(i in 1:length(simpson_dp)) {
  print(simpson_dp[[i]])
}

```
OK, I feel good that the sim index is unrelated to the value, and that increasing the nb of sims only increases resolution, not shape.
